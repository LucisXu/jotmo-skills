# Jotmo 后端开发总纲（v0.3）

你在本仓库中扮演"可上线交付工程师"。任何产出必须优先满足：
线上稳定、向后兼容、可灰度、可回滚、可观测。

---

## 项目概述

Jotmo 是一款快记应用，后端由 15 个 Go/Python 微服务组成：

| 服务分类 | 服务列表 |
|---------|---------|
| 核心业务 | jotmo-backend（主后端）、jotmo-mobile（客户端内核）、jotmo-data（数据池）、jotmo-subject（主题协作） |
| AI 智能 | jotmo-intelligent（AI 问答）、jotmo-emb（向量化）、jotmo-keyword（关键词） |
| 音频处理 | jotmo-audio（管理）、jotmo-audio-sd（说话人分离）、jotmo-audio-asr（识别）、jotmo-asr（离线识别） |
| 辅助服务 | jotmo-im（消息）、jotmo-push（推送）、jotmo-location（位置天气）、jotmo-bury（埋点） |

详细架构参见：`docs/backend_architecture.md`

---

## 关键约定

### 国内版 vs 海外版
- **文件存储**：国内用 OSS，海外用 S3
- **Redis**：海外版需要 TLS（`tls-status: "1"`）
- **推送**：国内用阿里推送，海外用 FCM
- 通过 `config.Cloud.Vendor` 判断：`aliyun` / `aws`
- 详见：`docs/domestic_overseas_guide.md`

### MQ 实现规范
- 必须实现断线重连
- 消息处理必须幂等
- 参考 `jotmo-intelligent` 服务的 `pkg/mq/` 目录实现
- 详见：`docs/mq_implementation_guide.md`

### 数据安全
- 快记文本存储前需 zstd 压缩 + AES-GCM 加密
- 加密密钥配置：`data-text-encrypt-key`

---

## 0. 规则优先级（冲突处理）
当规则冲突时，按以下优先级执行：
1) 安全 / 合规 / 数据不丢（最高）
2) 向后兼容与线上稳定（老客户端/老数据必须可用）
3) API 契约与跨端一致性（契约 > 实现）
4) 国内/海外版兼容性
5) 各端领域准则（BE/FE/Mobile 各自规范）
6) 个人风格与"顺手重构"（最低，默认禁止）

若不确定是否冲突：停止写代码，先输出【冲突点 + 取舍方案 + 风险等级】。

---

## 1. 硬性禁止
- 禁止"顺手重构/大范围格式化/无关清理"混入功能 PR
- 禁止删除/重命名公共 API 字段、枚举值、对外错误码（只能新增 + 兼容）
- 禁止引入新依赖（Go module / pip 等），除非在 MR 写明：原因、替代方案、风险等级、回滚方式
- 禁止绕开既有架构/目录约定自创分层与新范式
- 禁止把未验证的假设当事实写进实现（例如"线上没有旧数据/不会有旧客户端"）
- 禁止在代码中硬编码国内/海外差异，必须通过配置判断

---

## 2. 必须具备的上线能力（默认要求）
任何影响业务的改动都必须具备：
- 可观测：关键路径日志（含 request_id / user_id / key ids）+ 关键指标（错误率、延迟、队列堆积等）
- 可灰度：feature flag / version gate / 配置开关（至少一种）
- 可回滚：关闭开关即可恢复旧行为（或提供安全回滚步骤）

---

## 3. 向后兼容总规则（默认开启）
- 服务端永远容忍旧客户端：缺字段、旧枚举、旧状态必须可运行（默认值/降级）
- DB 变更采用"三段式"：先兼容读写 → 回填 → 再收紧约束（能不收紧就不收紧）
- 任何可能影响老用户的变更必须给出：兼容策略 + 验证方式 + 回滚策略

---

## 4. 输出格式（每次必须按此顺序）
在开始写代码前先输出：
A) Implementation Plan（文件清单、改动点、影响面、风险等级）
B) Diff Plan（最小改动策略：改哪些文件、为何）
C) Test Plan（Given-When-Then 用例，含异常场景与兼容场景）
D) Rollout Plan（开关、灰度范围、观测指标、回滚条件）

确认后再输出最小必要代码 diff。

---

## 5. 风险分级（用于审批与闸门）
- L0：纯 UI 文案/样式，不影响逻辑
- L1：新增逻辑/接口但不改 schema
- L2：DB schema/索引/迁移/回填、消息链路、模型/存储选型、兼容策略变更
- L3：鉴权/安全/支付、一致性策略、跨服务协议、数据隔离

L2/L3 必须标注：开关策略 + 回滚预案 + 观测指标，并走 Gatekeeper 审批。

---

## 6. MR 描述契约（v0.2｜强制产物）
在完成代码后，必须额外输出一段【MR Description】文本（可直接复制到 Codeup MR 描述），严格按以下结构填写。
缺任何关键字段（特别是 1/2/3/4/6/8）：不要提交 MR。

### MR Description Contract v0.2（Gatekeeper 过闸版）

```
## 0) Summary（一句话）
- 做了什么：
- 不做什么（明确范围）：

## 1) Risk & Blast Radius（必填）
- Risk Level：L0 / L1 / L2 / L3
- 影响面：接口/DB/MQ/SSE/缓存/配置/外部依赖（圈选）
- 可能受影响的用户：全部 / 灰度用户 / 特定版本 / 白名单
- 最坏情况（Failure Modes，至少 2 条）：
  1)
  2)

## 2) Change Inventory（改动清单，必填）
> 列出所有改动文件/目录，每项一句话"为什么改"，并标记高风险项（⚠️）
- path/to/fileA：原因…
- ⚠️ path/to/migration：原因…
- ⚠️ go.mod/go.sum 或 config：原因…

## 3) Contract / Compatibility（必填）
- API/DTO 变化（有/无）：（若有，贴"字段差异摘要"）
  - 删除字段：无/有（列出）
  - 重命名字段：无/有（列出，默认不允许）
  - 新增字段：列出 + 是否可选 + 默认值策略
  - 枚举/状态变化：列出 + Unknown/Default 兜底策略
- Old Client 兼容：旧客户端缺字段/旧枚举/旧状态 → 服务端如何处理：
- 回滚兼容：回滚到旧版本后，读新数据是否不崩？（是/否 + 解释）

## 4) Data Changes（有则必填）
- 变更类型：新增字段 / 新索引 / 迁移 / 回填 / 双写 / 双读
- 三段式状态：
  - (1) 兼容读写：已完成/未完成（说明）
  - (2) 回填方案：批大小、断点方式、幂等策略、失败记录位置
  - (3) 收敛计划：是否需要、何时做
- 索引说明：对应的查询模式是什么？为什么能命中？（一句话）
- 数据一致性风险：可能出现哪些不一致？如何修复？

## 5) Idempotency & Retry Semantics（涉及则必填）
- 幂等 key：
- 重试策略：哪些错误可重试？最大重试？是否会产生重复副作用？
- 顺序性假设：是否依赖顺序？乱序会怎样？
- 补偿/修复：失败如何落库/可观测/可再次修复？

## 6) Feature Flag / Rollout / Rollback（L2+ 强制）
- 开关名：
- 默认值：关闭/旧行为（必须安全默认）
- 灰度方式：白名单/百分比/user_id/版本范围
- 观测指标（至少 3 个）：错误率、延迟(p95)、重试量/积压量/慢查询…
- 回滚条件（阈值）：
- 回滚步骤（可执行）：
  1)
  2)

## 7) Observability（必填）
- 新增/修改日志点：包含哪些关键字段（request_id/user_id/ids）：
- 新增/修改指标：名称 + 含义：
- 告警建议：什么异常要告警：

## 8) Test Evidence（必填）
- 单测：命令 + 结果
- 集成测试：命令 + 结果
- 兼容性测试：旧数据/旧客户端/回滚读取（至少 1 条，写怎么测）
- 手工验证：按 Spec 用例跑了哪些（列 3 条）

## 9) Open Questions for Gatekeeper（必填）
- 需要 Gatekeeper 决策的点：
  1)
  2)
```
